<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Creating ADVFQ</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Creating ADVFQ</h1>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This article describes creating an ADVFQ ADaM with Visual Functioning
Questionnaire data for ophthalmology endpoints. It is to be used in
conjunction with the article on <a href="https://pharmaverse.github.io/admiral/articles/bds_finding.html">creating
a BDS dataset from SDTM</a>. As such, derivations and processes that are
not specific to ADVFQ are mostly absent, and the user is invited to
consult the aforementioned article for guidance.</p>
<p>The full, open-source VFQ questionnaire can be accessed <a href="https://www.nei.nih.gov/about/education-and-outreach/outreach-materials/visual-function-questionnaire-25">here</a>.</p>
<p><strong>Note</strong>: <em>All examples assume CDISC SDTM and/or ADaM
format as input unless otherwise specified. Also, some of the example
datasets in this vignette contain more records than are displayed by
default, but the number of displayed records can be expanded using the
selectors at the bottom.</em></p>
<div id="dataset-contents" class="section level2">
<h2>Dataset Contents</h2>
<p><code>{admiralophtha}</code> suggests to populate ADVFQ solely with
VFQ-related records. Any other questionnaire data should be placed in
separate datasets (e.g. ADQS).</p>
<p>The records in ADVFQ can be categorized in four groups:</p>
<ol style="list-style-type: decimal">
<li>The <strong>original</strong>/<strong>raw</strong> records coming
from the VFQ itself. These include both the Base items in the standard
VFQ-25 and the Optional items which can be added to form the VFQ-39.
Importantly, not all of the items are measured on the same scale.</li>
<li>The <strong>transformed</strong> records, which are in a one-to-one
correspondence with the original records and serve to recode the latter
on the same 0 - 100 scale.</li>
<li>The <strong>composite scores by category</strong>, which are means
of all the transformed records from within a category, e.g. “Near
activities score”. These composite scores can be calculated including or
excluding the Optional items.</li>
<li>The <strong>overall composite scores</strong>, which are means of
the composite scores, again including or excluding the Optional
items.</li>
</ol>
</div>
<div id="required-packages" class="section level2">
<h2>Required Packages</h2>
<p>The examples of this vignette require the following packages.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(admiral)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(pharmaversesdtm)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(admiraldev)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(admiralophtha)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(stringr)</span></code></pre></div>
</div>
</div>
<div id="programming-workflow" class="section level1">
<h1>Programming Workflow</h1>
<ul>
<li><a href="#setup_lookup">Reading In Data and Setting Up Lookup
Tables</a></li>
<li><a href="#mapping_raw">Initial Set Up and Mapping the Raw
Records</a></li>
<li><a href="#deriving_transformed">Deriving the Transformed
Parameters</a></li>
<li><a href="#deriving_composite">Deriving the Composite
Parameters</a></li>
<li><a href="#further">Further Derivations of Standard BDS
Variables</a></li>
<li><a href="#example">Example Script</a></li>
</ul>
<div id="setup_lookup" class="section level2">
<h2>Reading In Data and Setting Up Lookup Tables</h2>
<p>To start, all datasets needed for the creation of the VFQ analysis
dataset should be read into the environment. For the purpose of
demonstration we shall use the <code>{pharmaversesdtm}</code>
<code>qs_ophtha</code> and the <code>{admiral}</code> ADSL test
datasets. Note that the former only contains VFQ records.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;admiral_adsl&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;qs_ophtha&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>adsl <span class="ot">&lt;-</span> admiral_adsl</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>qs <span class="ot">&lt;-</span> qs_ophtha</span></code></pre></div>
<p>Next, it will prove useful to set up lookup tables ahead of time for
the <code>PARAM</code>/<code>PARAMCD</code> and <code>PARCATy</code>
variables for the original, transformed and composite parameters. This
is so that when the latter two are derived later in the script, we can
simply assign <code>PARAMCD</code> (or one of the <code>PARCATy</code>s)
and then perform a merge with the lookup tables to associate to them the
remaining variables as well. <strong>Please note that the mappings
described through these lookup tables may vary from company to company -
this is just what <code>{admiralophtha}</code> suggests.</strong></p>
<p>For convenience, we suggest setting up three separate lookup tables.
You can peruse how the tables are structured below - for the full set up
code, please visit the <a href="https://github.com/pharmaverse/admiralophtha/blob/main/inst/templates/ad_advfq.R">ad_advfq.R</a>
template. There is a special importance for the contents of
<code>PARCAT4</code> since this determines the categories which are then
averaged within the <a href="#deriving_composite">composite
parameters</a>. You can differentiate the Base Items from the Optional
ones using <code>PARCAT5</code>, and the original, transformed and
composite parameters using <code>PARCAT2</code>.</p>
<div id="original-items-param_lookup_original" class="section level4">
<h4>Original Items (<code>param_lookup_original</code>)</h4>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="5%" />
<col width="22%" />
<col width="4%" />
<col width="19%" />
<col width="9%" />
<col width="12%" />
<col width="19%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">QSTESTCD</th>
<th align="left">PARAM</th>
<th align="left">PARAMCD</th>
<th align="left">PARCAT1</th>
<th align="left">PARCAT2</th>
<th align="left">PARCAT3</th>
<th align="left">PARCAT4</th>
<th align="left">PARCAT5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">VFQ101</td>
<td align="left">Your Overall Health Is</td>
<td align="left">VFQ101</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">general health</td>
<td align="left">General Health</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">VFQ102</td>
<td align="left">Eyesight Using Both Eyes Is</td>
<td align="left">VFQ102</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">general vision</td>
<td align="left">General Vision</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">VFQ103</td>
<td align="left">How Often You Worry About Eyesight</td>
<td align="left">VFQ103</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">well-being/distress</td>
<td align="left">Vision Specific: Mental Health</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">VFQ104</td>
<td align="left">How Much Pain in and Around Eyes</td>
<td align="left">VFQ104</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">ocular pain</td>
<td align="left">Ocular Pain</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">VFQ105</td>
<td align="left">Difficulty Reading Newspapers</td>
<td align="left">VFQ105</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">near vision</td>
<td align="left">Near Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">VFQ106</td>
<td align="left">Difficulty Doing Work/Hobbies</td>
<td align="left">VFQ106</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">near vision</td>
<td align="left">Near Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">VFQ107</td>
<td align="left">Difficulty Finding on Crowded Shelf</td>
<td align="left">VFQ107</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">near vision</td>
<td align="left">Near Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">VFQ108</td>
<td align="left">Difficulty Reading Street Signs</td>
<td align="left">VFQ108</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">distance vision</td>
<td align="left">Distance Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">VFQ109</td>
<td align="left">Difficulty Going Down Step at Night</td>
<td align="left">VFQ109</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">distance vision</td>
<td align="left">Distance Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">VFQ110</td>
<td align="left">Difficulty Noticing Objects to Side</td>
<td align="left">VFQ110</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Original Items</td>
<td align="left">peripheral vision</td>
<td align="left">Peripheral Vision</td>
<td align="left">Base Item</td>
</tr>
</tbody>
</table>
</div>
<div id="transformed-records-param_lookup_transformed" class="section level4">
<h4>Transformed Records (<code>param_lookup_transformed</code>)</h4>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="27%" />
<col width="4%" />
<col width="17%" />
<col width="16%" />
<col width="11%" />
<col width="17%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">PARAM</th>
<th align="left">PARAMCD</th>
<th align="left">PARCAT1</th>
<th align="left">PARCAT2</th>
<th align="left">PARCAT3</th>
<th align="left">PARCAT4</th>
<th align="left">PARCAT5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Transformed - Your Overall Health Is</td>
<td align="left">QR01</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">general health</td>
<td align="left">General Health</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">Transformed - Eyesight Using Both Eyes Is</td>
<td align="left">QR02</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">general vision</td>
<td align="left">General Vision</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">Transformed - How Often You Worry About Eyesight</td>
<td align="left">QR03</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">well-being/distress</td>
<td align="left">Vision Specific: Mental Health</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">Transformed - How Much Pain in and Around Eyes</td>
<td align="left">QR04</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">ocular pain</td>
<td align="left">Ocular Pain</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">Transformed - Difficulty Reading Newspapers</td>
<td align="left">QR05</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">near vision</td>
<td align="left">Near Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">Transformed - Difficulty Doing Work/Hobbies</td>
<td align="left">QR06</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">near vision</td>
<td align="left">Near Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">Transformed - Difficulty Finding on Crowded Shelf</td>
<td align="left">QR07</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">near vision</td>
<td align="left">Near Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">Transformed - Difficulty Reading Street Signs</td>
<td align="left">QR08</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">distance vision</td>
<td align="left">Distance Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="odd">
<td align="left">Transformed - Difficulty Going Down Step at Night</td>
<td align="left">QR09</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">distance vision</td>
<td align="left">Distance Activities</td>
<td align="left">Base Item</td>
</tr>
<tr class="even">
<td align="left">Transformed - Difficulty Noticing Objects to Side</td>
<td align="left">QR10</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Transformed - Original Items</td>
<td align="left">peripheral vision</td>
<td align="left">Peripheral Vision</td>
<td align="left">Base Item</td>
</tr>
</tbody>
</table>
</div>
<div id="composite-records-param_lookup_composite" class="section level4">
<h4>Composite Records (<code>param_lookup_composite</code>)</h4>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="28%" />
<col width="5%" />
<col width="21%" />
<col width="9%" />
<col width="5%" />
<col width="24%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">PARAM</th>
<th align="left">PARAMCD</th>
<th align="left">PARCAT1</th>
<th align="left">PARCAT2</th>
<th align="left">PARCAT3</th>
<th align="left">PARCAT4</th>
<th align="left">PARCAT5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">General Health Score</td>
<td align="left">QSBGH</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">General Health</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="even">
<td align="left">General Vision Score</td>
<td align="left">QSBGV</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">General Vision</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="odd">
<td align="left">Near Activities Score</td>
<td align="left">QSBNA</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Near Activities</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="even">
<td align="left">Distance Activities Score</td>
<td align="left">QSBDA</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Distance Activities</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="odd">
<td align="left">Vision Specific: Social Functioning Score</td>
<td align="left">QSBSF</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Vision Specific: Social Functioning</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="even">
<td align="left">Color Vision Score</td>
<td align="left">QSBCV</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Color Vision</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="odd">
<td align="left">Peripheral Vision Score</td>
<td align="left">QSBPV</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Peripheral Vision</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="even">
<td align="left">Driving Score</td>
<td align="left">QSBDR</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Driving</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="odd">
<td align="left">Vision Specific: Role Difficulties Score</td>
<td align="left">QSBRD</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Vision Specific: Role Difficulties</td>
<td align="left">VFQ-25</td>
</tr>
<tr class="even">
<td align="left">Ocular Pain Score</td>
<td align="left">QSBOP</td>
<td align="left">VFQ-25 INTERVIEWER ADMINISTERED</td>
<td align="left">Derived Scale</td>
<td align="left">NA</td>
<td align="left">Ocular Pain</td>
<td align="left">VFQ-25</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="mapping_raw" class="section level2">
<h2>Initial Set Up and Mapping the Raw Records</h2>
<p>We can now start setting up ADVFQ by taking <code>qs</code> and
merging on some ADSL variables which are needed for BDS derivations
later down the line. Note that there is no need to merge on the whole
ADSL dataset immediately as in so doing we would be needlessly
increasing the size of the working dataset; the rest of the variables
can be merged on at the end.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>adsl_vars <span class="ot">&lt;-</span> <span class="fu">exprs</span>(TRTSDT, TRTEDT, TRT01A, TRT01P)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> qs <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="fu">derive_vars_merged</span>(</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="at">dataset_add =</span> adsl,</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    <span class="at">new_vars =</span> adsl_vars,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  )</span></code></pre></div>
<p>Now we can derive the analysis date (<code>ADT</code>) and analysis
relative day (<code>ADY</code>) variables. These derivations are
study-specific and so the ones below are just examples - the user is
again invited to consult the vignette on <a href="https://pharmaverse.github.io/admiral/articles/bds_finding.html">creating
a BDS dataset from SDTM</a> for details on this topic.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="fu">derive_vars_dt</span>(</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="at">new_vars_prefix =</span> <span class="st">&quot;A&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    <span class="at">dtc =</span> QSDTC</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">derive_vars_dy</span>(</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    <span class="at">reference_date =</span> TRTSDT,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>    <span class="at">source_vars =</span> <span class="fu">exprs</span>(ADT)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  )</span></code></pre></div>
<p>Next, we can assign <code>PARAMCD</code> for the original parameters
by merging with the <code>param_lookup_original</code> table we set up
earlier. Using <code>derive_vars_merged_lookup()</code> allows us to get
console-level feedback that all the <code>QSTESTCD</code>s have been
mapped. We only add <code>PARAMCD</code> for now, and will derive
<code>PARCATy</code> and <code>PARAM</code> later - again to avoid
carrying forward too many variables.</p>
<p>We can also derive <code>AVAL</code>, <code>AVALC</code> and
<code>BASETYPE</code> for the original records with a simple
<code>mutate()</code> statement, and then <code>AVISIT</code> and
<code>AVISITN</code> with study-specific logic.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="do">## Add PARAMCD for original parameters only - PARCATy and PARAM will be added later</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="fu">derive_vars_merged_lookup</span>(</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    <span class="at">dataset_add =</span> param_lookup_original,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(PARAMCD),</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(QSTESTCD)</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="at">AVAL =</span> QSSTRESN,</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    <span class="at">AVALC =</span> QSORRES,</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    <span class="at">BASETYPE =</span> <span class="st">&quot;LAST PERIOD 01&quot;</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    <span class="at">AVISIT =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(VISIT) <span class="sc">~</span> <span class="fu">str_to_title</span>(VISIT),</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>    ),</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>    <span class="at">AVISITN =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>      AVISIT <span class="sc">==</span> <span class="st">&quot;Baseline&quot;</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>      AVISIT <span class="sc">==</span> <span class="st">&quot;Week 12&quot;</span> <span class="sc">~</span> <span class="dv">12</span>,</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>      AVISIT <span class="sc">==</span> <span class="st">&quot;Week 24&quot;</span> <span class="sc">~</span> <span class="dv">24</span>,</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    ),</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>  )</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="co">#&gt; All `QSTESTCD` are mapped.</span></span></code></pre></div>
<p>Here’s what the data for the “Near Activities” and “Distance
Activities” questions looks like for one patient’s first two visits:</p>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="13%" />
<col width="41%" />
<col width="10%" />
<col width="9%" />
<col width="5%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">USUBJID</th>
<th align="left">QSTEST</th>
<th align="left">AVISIT</th>
<th align="left">PARAMCD</th>
<th align="right">AVAL</th>
<th align="left">AVALC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Reading Newspapers</td>
<td align="left">Baseline</td>
<td align="left">VFQ105</td>
<td align="right">1</td>
<td align="left">NO DIFFICULTY</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Doing Work/Hobbies</td>
<td align="left">Baseline</td>
<td align="left">VFQ106</td>
<td align="right">2</td>
<td align="left">VERY DIFFICULT</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Finding on Crowded Shelf</td>
<td align="left">Baseline</td>
<td align="left">VFQ107</td>
<td align="right">2</td>
<td align="left">SOME DIFFICULTY</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Reading Street Signs</td>
<td align="left">Baseline</td>
<td align="left">VFQ108</td>
<td align="right">2</td>
<td align="left">SOME DIFFICULTY</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Going Down Step at Night</td>
<td align="left">Baseline</td>
<td align="left">VFQ109</td>
<td align="right">2</td>
<td align="left">SOME DIFFICULTY</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Going Out to See Movies</td>
<td align="left">Baseline</td>
<td align="left">VFQ114</td>
<td align="right">1</td>
<td align="left">NO DIFFICULTY</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Reading Newspapers</td>
<td align="left">Week 12</td>
<td align="left">VFQ105</td>
<td align="right">3</td>
<td align="left">VERY DIFFICULT</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Doing Work/Hobbies</td>
<td align="left">Week 12</td>
<td align="left">VFQ106</td>
<td align="right">2</td>
<td align="left">VERY DIFFICULT</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Finding on Crowded Shelf</td>
<td align="left">Week 12</td>
<td align="left">VFQ107</td>
<td align="right">2</td>
<td align="left">SOME DIFFICULTY</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Difficulty Reading Street Signs</td>
<td align="left">Week 12</td>
<td align="left">VFQ108</td>
<td align="right">2</td>
<td align="left">SOME DIFFICULTY</td>
</tr>
</tbody>
</table>
</div>
<div id="deriving_transformed" class="section level2">
<h2>Deriving the Transformed Parameters</h2>
<p>Now we are ready to derive the transformed parameters. Excluding 15C
(see later down this section), all of these are derived by re-scaling a
single original record. As such, the prototypical code which can be used
to derive them is a call to <code>derive_extreme_records()</code> which
is structured as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">derive_extreme_records</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="at">dataset =</span> advfq,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="at">dataset_add =</span> advfq,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="at">filter_add =</span> QSTESTCD <span class="sc">==</span> <span class="st">&quot;VFQ1xx&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="at">AVAL =</span> <span class="fu">transform_range</span>(</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      <span class="at">source =</span> AVAL,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      <span class="at">source_range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="co"># or some other range, e.g. c(1, 6), depending on the parameter</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>      <span class="at">target_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>      <span class="at">flip_direction =</span> <span class="cn">TRUE</span> <span class="co"># or FALSE, depending on the parameter</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    ),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    <span class="at">PARAMCD =</span> <span class="st">&quot;QRxx&quot;</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  )</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>)</span></code></pre></div>
<p>The function <code>transform_range()</code> is a helper function from
<code>{admiral}</code> which performs the re-scaling. You will need to
specify the <code>source_range</code> (i.e. the range of possible values
for the original record) and whether or not to
<code>flip_direction</code> (i.e. whether higher values of the original
record correspond to better or worse outcomes). Note that both the
<code>source_range</code> and <code>flip_direction</code> <em>will</em>
change across parameters - for instance, the source range is
<code>c(1, 5)</code> for <code>PARAMCD == &quot;VFQ101&quot;</code> but
<code>c(1, 6)</code> for <code>PARAMCD == &quot;VFQ102&quot;</code>. As such it is
useful to group all parameters (excluding 15C, for which a different
approach will be needed) based on which transformation they require; in
so doing the transformations for each group can be done together.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>range1to5_flip_params <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="st">&quot;VFQ101&quot;</span>, <span class="st">&quot;VFQ103&quot;</span>, <span class="st">&quot;VFQ104&quot;</span>, <span class="st">&quot;VFQ105&quot;</span>, <span class="st">&quot;VFQ106&quot;</span>, <span class="st">&quot;VFQ107&quot;</span>, <span class="st">&quot;VFQ108&quot;</span>,</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="st">&quot;VFQ109&quot;</span>, <span class="st">&quot;VFQ110&quot;</span>, <span class="st">&quot;VFQ111&quot;</span>, <span class="st">&quot;VFQ112&quot;</span>, <span class="st">&quot;VFQ113&quot;</span>, <span class="st">&quot;VFQ114&quot;</span>, <span class="st">&quot;VFQ116&quot;</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="st">&quot;VFQ116A&quot;</span>, <span class="st">&quot;VFQ1A03&quot;</span>, <span class="st">&quot;VFQ1A04&quot;</span>, <span class="st">&quot;VFQ1A05&quot;</span>, <span class="st">&quot;VFQ1A06&quot;</span>, <span class="st">&quot;VFQ1A07&quot;</span>,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="st">&quot;VFQ1A08&quot;</span>, <span class="st">&quot;VFQ1A09&quot;</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>range1to6_flip_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;VFQ102&quot;</span>)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>range1to5_noflip_params <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="st">&quot;VFQ117&quot;</span>, <span class="st">&quot;VFQ118&quot;</span>, <span class="st">&quot;VFQ119&quot;</span>, <span class="st">&quot;VFQ120&quot;</span>, <span class="st">&quot;VFQ121&quot;</span>, <span class="st">&quot;VFQ122&quot;</span>, <span class="st">&quot;VFQ123&quot;</span>,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="st">&quot;VFQ124&quot;</span>, <span class="st">&quot;VFQ125&quot;</span>, <span class="st">&quot;VFQ1A11A&quot;</span>, <span class="st">&quot;VFQ1A11B&quot;</span>, <span class="st">&quot;VFQ1A12&quot;</span>, <span class="st">&quot;VFQ1A13&quot;</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>)</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>range0to10_noflip_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;VFQ1A01&quot;</span>, <span class="st">&quot;VFQ1A02&quot;</span>)</span></code></pre></div>
<p>For question 15C we have to be a little more careful as the
derivation depends on whether or not question 15C was asked at that
visit. If it was, then we can derive the transformed record as normal.
However, if it wasn’t, then we have to check the response to question
15B - if the response to 15B indicates that the patient has never driven
or given up driving (i.e. <code>QSSTRESN == 1</code>), then we set the
transformed record to 0; otherwise, we do not derive a transformed
record for that visit. To do this, we can set up a temporary flag
variable using <code>derive_var_merged_exist_flag()</code> to identify
visits where question 15C was not asked, and then use that flag in the
derivation of the transformed record for 15C.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  <span class="fu">derive_var_merged_exist_flag</span>(</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="at">dataset_add =</span> advfq,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(<span class="sc">!!!</span>adsl_vars, ADT, ADY),</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="at">new_var =</span> TEMP_VFQ115C_FL,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="at">condition =</span> QSTESTCD <span class="sc">==</span> <span class="st">&quot;VFQ115C&quot;</span>,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="at">true_value =</span> <span class="st">&quot;Y&quot;</span>,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    <span class="at">false_value =</span> <span class="st">&quot;N&quot;</span>,</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    <span class="at">missing_value =</span> <span class="st">&quot;M&quot;</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  )</span></code></pre></div>
<p>We can then derive the transformed records, including the special
handling for 15C, in a single call to <code>call_derivation()</code>,
since each call to <code>derive_extreme_records()</code> contains the
same assignment of <code>dataset</code>, <code>dataset_add</code> and
<code>keep_source_vars</code>, then only differs in the
<code>filter_add</code> and <code>set_values_to</code> arguments. Each
list passed to <code>variable_params</code> performs the transformation
for one of the groups of parameters set up above, including dynamical
generation of the <code>PARAMCD</code>, though 15C is done separately.
Note that we set <code>keep_source_vars = adsl_vars</code> to ensure
SDTM records do not get populated for derived parameters.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="fu">call_derivation</span>(</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    <span class="at">derivation =</span> derive_extreme_records,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="at">dataset =</span> .,</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="at">dataset_add =</span> .,</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="at">keep_source_vars =</span> <span class="fu">c</span>(</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>      <span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>),</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>      <span class="fu">exprs</span>(PARAMCD, AVISIT, AVISITN, ADT, ADY),</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>      adsl_vars</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    ),</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>    <span class="at">variable_params =</span> <span class="fu">list</span>(</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>        <span class="at">filter_add =</span> QSTESTCD <span class="sc">%in%</span> range1to5_flip_params <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">transform_range</span>(</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>            <span class="at">source =</span> AVAL,</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>            <span class="at">source_range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>            <span class="at">target_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>            <span class="at">flip_direction =</span> <span class="cn">TRUE</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>          ),</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="fu">str_replace</span>(QSTESTCD, <span class="st">&quot;VFQ1&quot;</span>, <span class="st">&quot;QR&quot;</span>)</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>        )</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>      ),</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>        <span class="at">filter_add =</span> QSTESTCD <span class="sc">%in%</span> range1to6_flip_params <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">transform_range</span>(</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>            <span class="at">source =</span> AVAL,</span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>            <span class="at">source_range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">6</span>),</span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>            <span class="at">target_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a>            <span class="at">flip_direction =</span> <span class="cn">TRUE</span></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>          ),</span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="fu">str_replace</span>(QSTESTCD, <span class="st">&quot;VFQ1&quot;</span>, <span class="st">&quot;QR&quot;</span>)</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a>        )</span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a>      ),</span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>        <span class="at">filter_add =</span> QSTESTCD <span class="sc">%in%</span> range1to5_noflip_params <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">transform_range</span>(</span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a>            <span class="at">source =</span> AVAL,</span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>            <span class="at">source_range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>            <span class="at">target_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>            <span class="at">flip_direction =</span> <span class="cn">FALSE</span></span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>          ),</span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="fu">str_replace</span>(QSTESTCD, <span class="st">&quot;VFQ1&quot;</span>, <span class="st">&quot;QR&quot;</span>)</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>        )</span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>      ),</span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a>        <span class="at">filter_add =</span> QSTESTCD <span class="sc">%in%</span> range0to10_noflip_params <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">transform_range</span>(</span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>            <span class="at">source =</span> AVAL,</span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>            <span class="at">source_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>            <span class="at">target_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>            <span class="at">flip_direction =</span> <span class="cn">FALSE</span></span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>          ),</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="fu">str_replace</span>(QSTESTCD, <span class="st">&quot;VFQ1&quot;</span>, <span class="st">&quot;QR&quot;</span>)</span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a>        )</span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a>      ),</span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a>      <span class="co"># For QR15C, do it in two parts</span></span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a>      <span class="co"># first in the case where QSTESTCD == &quot;VFQ115C&quot; is present at that visit</span></span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb13-63"><a href="#cb13-63" tabindex="-1"></a>        <span class="at">filter_add =</span> QSTESTCD <span class="sc">==</span> <span class="st">&quot;VFQ115C&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb13-64"><a href="#cb13-64" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb13-65"><a href="#cb13-65" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">transform_range</span>(</span>
<span id="cb13-66"><a href="#cb13-66" tabindex="-1"></a>            <span class="at">source =</span> AVAL,</span>
<span id="cb13-67"><a href="#cb13-67" tabindex="-1"></a>            <span class="at">source_range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb13-68"><a href="#cb13-68" tabindex="-1"></a>            <span class="at">target_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>),</span>
<span id="cb13-69"><a href="#cb13-69" tabindex="-1"></a>            <span class="at">flip_direction =</span> <span class="cn">TRUE</span></span>
<span id="cb13-70"><a href="#cb13-70" tabindex="-1"></a>          ),</span>
<span id="cb13-71"><a href="#cb13-71" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="st">&quot;QR15C&quot;</span></span>
<span id="cb13-72"><a href="#cb13-72" tabindex="-1"></a>        )</span>
<span id="cb13-73"><a href="#cb13-73" tabindex="-1"></a>      ),</span>
<span id="cb13-74"><a href="#cb13-74" tabindex="-1"></a>      <span class="co"># second in the case where QSTESTCD == &quot;VFQ115C&quot; is not present at that visit</span></span>
<span id="cb13-75"><a href="#cb13-75" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb13-76"><a href="#cb13-76" tabindex="-1"></a>        <span class="at">filter_add =</span> TEMP_VFQ115C_FL <span class="sc">==</span> <span class="st">&quot;N&quot;</span> <span class="sc">&amp;</span> QSTESTCD <span class="sc">==</span> <span class="st">&quot;VFQ115B&quot;</span> <span class="sc">&amp;</span> AVAL <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb13-77"><a href="#cb13-77" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb13-78"><a href="#cb13-78" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="dv">0</span>,</span>
<span id="cb13-79"><a href="#cb13-79" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="st">&quot;QR15C&quot;</span></span>
<span id="cb13-80"><a href="#cb13-80" tabindex="-1"></a>        )</span>
<span id="cb13-81"><a href="#cb13-81" tabindex="-1"></a>      )</span>
<span id="cb13-82"><a href="#cb13-82" tabindex="-1"></a>    )</span>
<span id="cb13-83"><a href="#cb13-83" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-84"><a href="#cb13-84" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>TEMP_VFQ115C_FL)</span></code></pre></div>
<p>We can then add the <code>PARAM</code> and <code>PARCATy</code>
variables for both the original and transformed records by merging with
the relevant lookup tables.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  <span class="fu">derive_vars_merged_lookup</span>(</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="at">dataset_add =</span> <span class="fu">rbind</span>(</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>      param_lookup_original <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>QSTESTCD),</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>      param_lookup_transformed</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    ),</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(PARAMCD)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  )</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="co">#&gt; All `PARAMCD` are mapped.</span></span></code></pre></div>
<p>Here’s what some of the transformed parameters and original records
look like alongside each other for one patient’s first two visits:</p>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="14%" />
<col width="10%" />
<col width="59%" />
<col width="9%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">USUBJID</th>
<th align="left">AVISIT</th>
<th align="left">PARAM</th>
<th align="left">PARAMCD</th>
<th align="right">AVAL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Your Overall Health Is</td>
<td align="left">QR01</td>
<td align="right">75</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Eyesight Using Both Eyes Is</td>
<td align="left">QR02</td>
<td align="right">80</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Eye Pain Keep From Doing What Like</td>
<td align="left">QR19</td>
<td align="right">25</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Your Overall Health Is</td>
<td align="left">VFQ101</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Eyesight Using Both Eyes Is</td>
<td align="left">VFQ102</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Eye Pain Keep From Doing What Like</td>
<td align="left">VFQ119</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Week 12</td>
<td align="left">Transformed - Your Overall Health Is</td>
<td align="left">QR01</td>
<td align="right">25</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Week 12</td>
<td align="left">Transformed - Eyesight Using Both Eyes Is</td>
<td align="left">QR02</td>
<td align="right">40</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Week 12</td>
<td align="left">Transformed - Eye Pain Keep From Doing What Like</td>
<td align="left">QR19</td>
<td align="right">25</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Week 12</td>
<td align="left">Your Overall Health Is</td>
<td align="left">VFQ101</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
</div>
<div id="deriving_composite" class="section level2">
<h2>Deriving the Composite Parameters</h2>
<div id="composite-scores-by-category" class="section level3">
<h3>Composite Scores by Category</h3>
<p>With the now-derived transformed parameters (identifiable through
<code>PARCAT2 == &quot;Transformed - Original Items&quot;</code>), we have every
question measured on the same scale and can derive the composite
parameters. These are essentially just means across categories of
questions, with the category being determined by the contents of
<code>PARCAT4</code>. The VFQ guidelines dictate that for each category,
two different composite parameters should be derived: one including just
the Base items of the questionnaire
(<code>PARCAT5 == &quot;Base Item&quot;</code>) and the other one also including
any Optional items. As such, below we derive the composite parameters in
two stages, first constructing <code>advfq_qsb</code> for the Base
item-only composite means, and then <code>advfq_qso</code> for the means
including all items.</p>
<p>Note that the <code>dataset</code> argument is not passed to
<code>derive_summary_records()</code>, meaning the output datasets
contain only the new composite parameters. Also, this time we use
<code>PARCAT4</code> as a by-variable, meaning that the new composite
scores are assigned the same value of <code>PARCAT4</code>
(e.g. “Distance Activities”) as the records that were used to constitute
them. Then, we can then use <code>derive_vars_merged_lookup()</code> to
add on the <code>PARCATy</code> (excluding <code>PARCAT4</code>) and
<code>PARAM</code>/<code>PARAMCD</code> variables for these new records.
At the end, we append the new records to the existing <code>advfq</code>
using <code>bind_rows()</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>advfq_qsb <span class="ot">&lt;-</span> <span class="fu">derive_summary_records</span>(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="at">dataset_add =</span> advfq,</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  <span class="at">filter_add =</span> PARCAT2 <span class="sc">==</span> <span class="st">&quot;Transformed - Original Items&quot;</span> <span class="sc">&amp;</span> PARCAT5 <span class="sc">==</span> <span class="st">&quot;Base Item&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  <span class="at">by_vars =</span> <span class="fu">c</span>(</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    <span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>),</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    <span class="fu">exprs</span>(<span class="sc">!!!</span>adsl_vars, AVISIT, AVISITN, ADT, ADY, PARCAT4)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>  ),</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>  <span class="at">set_values_to =</span> <span class="fu">exprs</span>(<span class="at">AVAL =</span> <span class="fu">mean</span>(AVAL))</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  <span class="fu">derive_vars_merged_lookup</span>(</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    <span class="at">dataset_add =</span> <span class="fu">filter</span>(param_lookup_composite, <span class="fu">str_starts</span>(PARAMCD, <span class="st">&quot;QSB&quot;</span>)),</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(PARAMCD, PARAM, PARCAT1, PARCAT2, PARCAT3, PARCAT5),</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(PARCAT4)</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>  )</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="co">#&gt; All `PARCAT4` are mapped.</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>advfq_qso <span class="ot">&lt;-</span> <span class="fu">derive_summary_records</span>(</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>  <span class="at">dataset_add =</span> advfq,</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>  <span class="at">filter_add =</span> PARCAT2 <span class="sc">==</span> <span class="st">&quot;Transformed - Original Items&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>  <span class="at">by_vars =</span> <span class="fu">c</span>(</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>    <span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>),</span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>    <span class="fu">exprs</span>(<span class="sc">!!!</span>adsl_vars, AVISIT, AVISITN, ADT, ADY, PARCAT4)</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>  ),</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>  <span class="at">set_values_to =</span> <span class="fu">exprs</span>(<span class="at">AVAL =</span> <span class="fu">mean</span>(AVAL))</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>  <span class="fu">derive_vars_merged_lookup</span>(</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>    <span class="at">dataset_add =</span> <span class="fu">filter</span>(param_lookup_composite, <span class="fu">str_starts</span>(PARAMCD, <span class="st">&quot;QSO&quot;</span>)),</span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(PARAMCD, PARAM, PARCAT1, PARCAT2, PARCAT3, PARCAT5),</span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(PARCAT4)</span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a>  )</span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">#&gt; All `PARCAT4` are mapped.</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(advfq, advfq_qsb, advfq_qso)</span></code></pre></div>
<p>Here’s what the Base item composite scores by category look like for
the “Near Activities” and “Distance Activities” categories for one
patient’s first two visits:</p>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="11%" />
<col width="8%" />
<col width="45%" />
<col width="7%" />
<col width="18%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">USUBJID</th>
<th align="left">AVISIT</th>
<th align="left">PARAM</th>
<th align="left">PARAMCD</th>
<th align="left">PARCAT4</th>
<th align="right">AVAL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Difficulty Reading Newspapers</td>
<td align="left">QR05</td>
<td align="left">Near Activities</td>
<td align="right">100.00000</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Difficulty Doing Work/Hobbies</td>
<td align="left">QR06</td>
<td align="left">Near Activities</td>
<td align="right">75.00000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Difficulty Finding on Crowded Shelf</td>
<td align="left">QR07</td>
<td align="left">Near Activities</td>
<td align="right">75.00000</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Difficulty Reading Street Signs</td>
<td align="left">QR08</td>
<td align="left">Distance Activities</td>
<td align="right">75.00000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Difficulty Going Down Step at Night</td>
<td align="left">QR09</td>
<td align="left">Distance Activities</td>
<td align="right">75.00000</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Transformed - Difficulty Going Out to See Movies</td>
<td align="left">QR14</td>
<td align="left">Distance Activities</td>
<td align="right">100.00000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Distance Activities Score</td>
<td align="left">QSBDA</td>
<td align="left">Distance Activities</td>
<td align="right">83.33333</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Near Activities Score</td>
<td align="left">QSBNA</td>
<td align="left">Near Activities</td>
<td align="right">83.33333</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Week 12</td>
<td align="left">Transformed - Difficulty Reading Newspapers</td>
<td align="left">QR05</td>
<td align="left">Near Activities</td>
<td align="right">50.00000</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Week 12</td>
<td align="left">Transformed - Difficulty Doing Work/Hobbies</td>
<td align="left">QR06</td>
<td align="left">Near Activities</td>
<td align="right">75.00000</td>
</tr>
</tbody>
</table>
</div>
<div id="overall-composite-scores" class="section level3">
<h3>Overall Composite Scores</h3>
<p>Finally, for the overall composite scores, we take all the
newly-derived composite parameters, excluding “General Health”, and
create:</p>
<ul>
<li>An averaged record (<code>PARAMCD == &quot;QBCSCORE&quot;</code>) using the
composite scores that were calculated with Base items only;</li>
<li>An averaged record (<code>PARAMCD == &quot;QOCSCORE&quot;</code>) using the
composite scores that were calculated with Base and Optional items.</li>
</ul>
<p>As was done for the <a href="#deriving_transformed">transformed
parameters</a>, we do this in a single call to
<code>call_derivation()</code>, since the only difference between the
two derivations is the <code>filter_add</code> and
<code>set_values_to</code> arguments.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="fu">call_derivation</span>(</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="at">derivation =</span> derive_summary_records,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="at">dataset_add =</span> advfq,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">c</span>(</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>      <span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>),</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>      <span class="fu">exprs</span>(<span class="sc">!!!</span>adsl_vars, AVISIT, AVISITN, ADT, ADY)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>    ),</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>    <span class="at">variable_params =</span> <span class="fu">list</span>(</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>        <span class="co"># Use Base Items only</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>        <span class="at">filter_add =</span> PARCAT5 <span class="sc">==</span> <span class="st">&quot;VFQ-25&quot;</span> <span class="sc">&amp;</span> <span class="fu">str_sub</span>(PARAMCD, <span class="dv">1</span>, <span class="dv">3</span>) <span class="sc">==</span> <span class="st">&quot;QSB&quot;</span> <span class="sc">&amp;</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>          PARCAT4 <span class="sc">!=</span> <span class="st">&quot;General Health&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">mean</span>(AVAL),</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="st">&quot;QBCSCORE&quot;</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>        )</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>      ),</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>      <span class="fu">params</span>(</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>        <span class="co"># Use optional items items only</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>        <span class="at">filter_add =</span> PARCAT5 <span class="sc">==</span> <span class="st">&quot;VFQ-39&quot;</span> <span class="sc">&amp;</span> <span class="fu">str_sub</span>(PARAMCD, <span class="dv">1</span>, <span class="dv">3</span>) <span class="sc">==</span> <span class="st">&quot;QSO&quot;</span> <span class="sc">&amp;</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>          PARCAT4 <span class="sc">!=</span> <span class="st">&quot;General Health&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(AVAL),</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>        <span class="at">set_values_to =</span> <span class="fu">exprs</span>(</span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>          <span class="at">AVAL =</span> <span class="fu">mean</span>(AVAL),</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a>          <span class="at">PARAMCD =</span> <span class="st">&quot;QOCSCORE&quot;</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a>        )</span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a>      )</span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>    )</span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a>  )</span></code></pre></div>
<p>We then assign <code>PARAM</code>/<code>PARAMCD</code> and
<code>PARCATy</code> for these new overall composite records by merging
with the relevant lookup table, and append them to
<code>advfq</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>advfq <span class="ot">&lt;-</span> advfq <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(PARAMCD, <span class="st">&quot;SCORE&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>PARAM, <span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">&quot;PARCAT&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="fu">derive_vars_merged_lookup</span>(</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>    <span class="at">dataset_add =</span> param_lookup_composite,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(PARAM, PARCAT1, PARCAT2, PARCAT3, PARCAT4, PARCAT5),</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(PARAMCD)</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  <span class="fu">rbind</span>(advfq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(PARAMCD, <span class="st">&quot;SCORE&quot;</span>)))</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="co">#&gt; All `PARAMCD` are mapped.</span></span></code></pre></div>
<p>Here’s what the overall composite records using the Base and Optional
items for one patient’s baseline visit:</p>
<pre><code>#&gt; Warning in attr(x, &quot;align&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)
#&gt; Warning in attr(x, &quot;format&quot;): &#39;xfun::attr()&#39; is deprecated.
#&gt; Use &#39;xfun::attr2()&#39; instead.
#&gt; See help(&quot;Deprecated&quot;)</code></pre>
<table>
<colgroup>
<col width="9%" />
<col width="6%" />
<col width="45%" />
<col width="6%" />
<col width="23%" />
<col width="7%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">USUBJID</th>
<th align="left">AVISIT</th>
<th align="left">PARAM</th>
<th align="left">PARAMCD</th>
<th align="left">PARCAT4</th>
<th align="right">AVAL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Composite Score (incl. Optional Items)</td>
<td align="left">QOCSCORE</td>
<td align="left">Composite Score</td>
<td align="right">70.50000</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Color Vision Score (incl. Optional Items)</td>
<td align="left">QSOCV</td>
<td align="left">Color Vision</td>
<td align="right">100.00000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Distance Activities Score (incl. Optional Items)</td>
<td align="left">QSODA</td>
<td align="left">Distance Activities</td>
<td align="right">66.66667</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Vision Specific: Dependency Score (incl. Optional
Items)</td>
<td align="left">QSODP</td>
<td align="left">Vision Specific: Dependency</td>
<td align="right">37.50000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Driving Score (incl. Optional Items)</td>
<td align="left">QSODR</td>
<td align="left">Driving</td>
<td align="right">91.66667</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">General Vision Score (incl. Optional Items)</td>
<td align="left">QSOGV</td>
<td align="left">General Vision</td>
<td align="right">80.00000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Vision Specific: Mental Health Score (incl. Optional
Items)</td>
<td align="left">QSOMH</td>
<td align="left">Vision Specific: Mental Health</td>
<td align="right">66.66667</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Near Activities Score (incl. Optional Items)</td>
<td align="left">QSONA</td>
<td align="left">Near Activities</td>
<td align="right">87.50000</td>
</tr>
<tr class="odd">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Ocular Pain Score (incl. Optional Items)</td>
<td align="left">QSOOP</td>
<td align="left">Ocular Pain</td>
<td align="right">37.50000</td>
</tr>
<tr class="even">
<td align="left">01-701-1034</td>
<td align="left">Baseline</td>
<td align="left">Peripheral Vision Score (incl. Optional Items)</td>
<td align="left">QSOPV</td>
<td align="left">Peripheral Vision</td>
<td align="right">75.00000</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="further" class="section level2">
<h2>Further Derivations of Standard BDS Variables</h2>
<p>The user is invited to consult the article on <a href="https://pharmaverse.github.io/admiral/articles/bds_finding.html">creating
a BDS dataset from SDTM</a> to learn how to add standard BDS variables
to ADVFQ.</p>
</div>
<div id="example" class="section level2">
<h2>Example Script</h2>
<table>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th>ADaM</th>
<th>Sample Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ADVFQ</td>
<td><a href="https://github.com/pharmaverse/admiralophtha/blob/main/inst/templates/ad_advfq.R">ad_advfq.R</a></td>
</tr>
</tbody>
</table>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
